name: Build and Release

on:
  push:
    branches: [main]
    paths:
      - 'documento.md'
      - 'references.bib'
      - 'metadata.yaml'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Pandoc and LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended texlive-latex-extra

      - name: Build PDF and DOCX
        run: bash scripts/build.sh

      - name: Generate version tag
        id: version
        run: |
          VERSION_TAG="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
          echo "tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION_TAG}"

      - name: Get commit message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "${COMMIT_MSG}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Proposta Cannabis ${{ steps.version.outputs.tag }}
          body: |
            ## Vers√£o Autom√°tica

            Gerada a partir do commit: `${{ github.sha }}`

            **√öltima altera√ß√£o:**
            ```
            ${{ steps.commit.outputs.message }}
            ```

            ### Ficheiros dispon√≠veis:
            - üìÑ `documento.pdf` - Vers√£o PDF completa
            - üìù `documento.docx` - Vers√£o Word edit√°vel

            ### Como ver altera√ß√µes:
            - [Ver diff desde √∫ltima release](../../compare/${{ github.event.before }}...${{ github.sha }})
            - [Ver commits](../../commits/main)
            - [Ver documento fonte](../../blob/main/documento.md)

            ---
            ü§ñ Release autom√°tica via GitHub Actions
          files: |
            output/documento.pdf
            output/documento.docx
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
